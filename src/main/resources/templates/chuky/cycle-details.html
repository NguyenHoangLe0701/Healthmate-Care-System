<!DOCTYPE html>
<html
  lang="vi"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout}"
>
  <head>
    <title>K·∫øt qu·∫£ t√≠nh ng√†y r·ª•ng tr·ª©ng</title>
    <link rel="stylesheet" th:href="@{/css/cycle_detail.css}" />
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        document
          .querySelectorAll(".cycle-calendar-cell")
          .forEach(function (cell) {
            cell.addEventListener("click", function () {
              document
                .querySelectorAll(".cycle-calendar-cell.selected")
                .forEach(function (sel) {
                  sel.classList.remove("selected");
                });
              cell.classList.add("selected");
            });
          });
      });
    </script>
  </head>
  <body>
    <div layout:fragment="content">
      <div class="cycle-app-bg">
        <div class="cycle-container">
          <ul class="cycle-info-list">
            <li>
              Ng√†y b·∫Øt ƒë·∫ßu:
              <span
                th:text="${#temporals.format(cycle.startDate, 'dd-MM-yyyy')}"
              ></span>
            </li>
            <li>
              ƒê·ªô d√†i chu k·ª≥: <span th:text="${cycle.cycleLength}"></span> ng√†y
            </li>
            <li>
              S·ªë ng√†y h√†nh kinh:
              <span th:text="${cycle.periodLength}"></span> ng√†y
            </li>
          </ul>
          <hr />
          <div class="cycle-title">K·∫øt qu·∫£ c·ªßa b·∫°n</div>
          <div class="cycle-month-nav">
            <th:block th:if="${prev2Month != null}">
              <a
                class="cycle-month-link"
                th:href="@{|/cycles/details/${cycle.id}?month=${prev2Month}&year=${prev2Year}|}"
                >&laquo;</a
              >
            </th:block>
            <th:block th:if="${prev2Month == null}">
              <span class="cycle-month-link cycle-disabled">&laquo;</span>
            </th:block>
            <th:block th:if="${prevMonth != null}">
              <a
                class="cycle-month-link"
                th:href="@{|/cycles/details/${cycle.id}?month=${prevMonth}&year=${prevYear}|}"
                >&lt;</a
              >
            </th:block>
            <th:block th:if="${prevMonth == null}">
              <span class="cycle-month-link cycle-disabled">&lt;</span>
            </th:block>
            <span class="cycle-month-title">
              Th√°ng <span th:text="${showMonth}"></span> -
              <span th:text="${showYear}"></span>
            </span>
            <th:block th:if="${nextMonth != null}">
              <a
                class="cycle-month-link"
                th:href="@{|/cycles/details/${cycle.id}?month=${nextMonth}&year=${nextYear}|}"
                >&gt;</a
              >
            </th:block>
            <th:block th:if="${nextMonth == null}">
              <span class="cycle-month-link cycle-disabled">&gt;</span>
            </th:block>
            <th:block th:if="${next2Month != null}">
              <a
                class="cycle-month-link"
                th:href="@{|/cycles/details/${cycle.id}?month=${next2Month}&year=${next2Year}|}"
                >&raquo;</a
              >
            </th:block>
            <th:block th:if="${next2Month == null}">
              <span class="cycle-month-link cycle-disabled">&raquo;</span>
            </th:block>
          </div>
          <table class="cycle-calendar-table">
            <thead>
              <tr>
                <th class="cycle-calendar-header">CN</th>
                <th class="cycle-calendar-header">Th·ª© 2</th>
                <th class="cycle-calendar-header">Th·ª© 3</th>
                <th class="cycle-calendar-header">Th·ª© 4</th>
                <th class="cycle-calendar-header">Th·ª© 5</th>
                <th class="cycle-calendar-header">Th·ª© 6</th>
                <th class="cycle-calendar-header">Th·ª© 7</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="week : ${weeks}">
                <td
                  th:each="day : ${week}"
                  th:classappend="'cycle-calendar-cell ' + (${day != null} ? 
                  (${cycleDayLabels[day.toString()]} == 'Ng√†y c√≥ kinh nguy·ªát' ? 'cycle-bg-menstruation' :
                  (${cycleDayLabels[day.toString()]} == 'Ng√†y b·∫Øt ƒë·∫ßu c√≥ kh·∫£ nƒÉng th·ª• thai' ? 'cycle-bg-fertile-start' :
                  (${cycleDayLabels[day.toString()]} == 'Ng√†y c√≥ kh·∫£ nƒÉng th·ª• thai (ng√†y th·ª© hai)' ? 'cycle-bg-fertile-2' :
                  (${cycleDayLabels[day.toString()]} == 'Ng√†y c√≥ kh·∫£ nƒÉng th·ª• thai (hai ng√†y tr∆∞·ªõc r·ª•ng tr·ª©ng)' ? 'cycle-bg-fertile-3' :
                  (${cycleDayLabels[day.toString()]} == 'Ng√†y c√≥ kh·∫£ nƒÉng th·ª• thai cao' ? 'cycle-bg-fertile-high' :
                  (${cycleDayLabels[day.toString()]} == 'Ng√†y tr·ª©ng r·ª•ng, c√≥ kh·∫£ nƒÉng th·ª• thai cao nh·∫•t' ? 'cycle-bg-ovulation' :
                  (${cycleDayLabels[day.toString()]} == 'T·ª∑ l·ªá th·ª• thai gi·∫£m' ? 'cycle-bg-test' :
                  (${cycleDayLabels[day.toString()]} == 'Ng√†y an to√†n t∆∞∆°ng ƒë·ªëi' ? 'cycle-bg-safe' :
                  (${cycleDayLabels[day.toString()]} == 'Ng√†y an to√†n tuy·ªát ƒë·ªëi' ? 'cycle-bg-safe-absolute' :
                  (${cycleDayLabels[day.toString()]} == 'Th·ª≠ thai' ? 'cycle-bg-test' :
                  (${cycleDayLabels[day.toString()]} == 'Ng√†y c√≥ kh·∫£ nƒÉng th·ª• thai' ? 'cycle-bg-fertile-2' : 'cycle-bg-default'))))))))))) : '')"
                >
                  <div th:if="${day != null}">
                    <span class="cycle-day-number">
                      <span th:text="${day.dayOfMonth}"></span>
                      <span
                        th:if="${day.dayOfMonth == 1}"
                        style="font-size: 10px; color: #888"
                        >/ <span th:text="${day.monthValue}"></span>
                      </span>
                    </span>
                    <div class="cycle-icon-wrapper">
                      <span th:switch="${cycleDayLabels[day.toString()]}">
                        <img
                          th:case="'Ng√†y c√≥ kinh nguy·ªát'"
                          class="cycle-calendar-icon"
                          th:src="@{/images/sinhsan/menstruation.svg}"
                          alt="Ng√†y c√≥ kinh nguy·ªát"
                        />
                        <img
                          th:case="'Ng√†y b·∫Øt ƒë·∫ßu c√≥ kh·∫£ nƒÉng th·ª• thai'"
                          class="cycle-calendar-icon"
                          th:src="@{/images/sinhsan/ovulation-1.svg}"
                          alt="Ng√†y b·∫Øt ƒë·∫ßu c√≥ kh·∫£ nƒÉng th·ª• thai"
                        />
                        <img
                          th:case="'Ng√†y c√≥ kh·∫£ nƒÉng th·ª• thai (ng√†y th·ª© hai)'"
                          class="cycle-calendar-icon"
                          th:src="@{/images/sinhsan/ovulation-2.svg}"
                          alt="Ng√†y c√≥ kh·∫£ nƒÉng th·ª• thai (ng√†y th·ª© hai)"
                        />
                        <img
                          th:case="'Ng√†y c√≥ kh·∫£ nƒÉng th·ª• thai (hai ng√†y tr∆∞·ªõc r·ª•ng tr·ª©ng)'"
                          class="cycle-calendar-icon"
                          th:src="@{/images/sinhsan/ovulation-3.svg}"
                          alt="Ng√†y c√≥ kh·∫£ nƒÉng th·ª• thai (hai ng√†y tr∆∞·ªõc r·ª•ng tr·ª©ng)"
                        />
                        <img
                          th:case="'Ng√†y c√≥ kh·∫£ nƒÉng th·ª• thai cao'"
                          class="cycle-calendar-icon"
                          th:src="@{/images/sinhsan/ovulation-4.svg}"
                          alt="Ng√†y c√≥ kh·∫£ nƒÉng th·ª• thai cao"
                        />
                        <img
                          th:case="'Ng√†y tr·ª©ng r·ª•ng, c√≥ kh·∫£ nƒÉng th·ª• thai cao nh·∫•t'"
                          class="cycle-calendar-icon"
                          th:src="@{/images/sinhsan/ovulation-5.svg}"
                          alt="Ng√†y tr·ª©ng r·ª•ng, c√≥ kh·∫£ nƒÉng th·ª• thai cao nh·∫•t"
                        />
                        <img
                          th:case="'T·ª∑ l·ªá th·ª• thai gi·∫£m'"
                          class="cycle-calendar-icon"
                          th:src="@{/images/sinhsan/ovulation-6.svg}"
                          alt="T·ª∑ l·ªá th·ª• thai gi·∫£m"
                        />
                        <img
                          th:case="'Ng√†y c√≥ kh·∫£ nƒÉng th·ª• thai'"
                          class="cycle-calendar-icon"
                          th:src="@{/images/sinhsan/ovulation-2.svg}"
                          alt="Ng√†y c√≥ kh·∫£ nƒÉng th·ª• thai"
                        />
                        <img
                          th:case="'Ng√†y an to√†n t∆∞∆°ng ƒë·ªëi'"
                          class="cycle-calendar-icon"
                          th:src="@{/images/sinhsan/relatively-safe.svg}"
                          alt="Ng√†y an to√†n t∆∞∆°ng ƒë·ªëi"
                        />
                        <img
                          th:case="'Ng√†y an to√†n tuy·ªát ƒë·ªëi'"
                          class="cycle-calendar-icon"
                          th:src="@{/images/sinhsan/absolutely-safe.svg}"
                          alt="Ng√†y an to√†n tuy·ªát ƒë·ªëi"
                        />
                        <img
                          th:case="'Th·ª≠ thai'"
                          class="cycle-calendar-icon"
                          th:src="@{/images/sinhsan/test-pregnancy.svg}"
                          alt="Th·ª≠ thai"
                        />
                      </span>
                    </div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>

          <div class="cycle-legend">
            <h4 class="cycle-legend-title">Ch√∫ th√≠ch bi·ªÉu t∆∞·ª£ng</h4>
            <ul class="cycle-legend-list">
              <li>
                <img
                  class="cycle-legend-icon"
                  th:src="@{/images/sinhsan/menstruation.svg}"
                  alt="Ng√†y c√≥ kinh nguy·ªát"
                />
                <b>Ng√†y c√≥ kinh nguy·ªát</b
                ><span style="margin-left: 6px"
                  >ƒê√¢y l√† ng√†y c√≥ k·ª≥ kinh nguy·ªát c·ªßa b·∫°n.</span
                >
              </li>
              <li>
                <img
                  class="cycle-legend-icon"
                  th:src="@{/images/sinhsan/ovulation-1.svg}"
                  alt="Ng√†y b·∫Øt ƒë·∫ßu c√≥ kh·∫£ nƒÉng th·ª• thai"
                />
                <b>Ng√†y b·∫Øt ƒë·∫ßu c√≥ kh·∫£ nƒÉng th·ª• thai</b
                ><span style="margin-left: 6px"
                  >Ng√†y ƒë·∫ßu ti√™n trong c·ª≠a s·ªï th·ª• thai.</span
                >
              </li>
              <li>
                <img
                  class="cycle-legend-icon"
                  th:src="@{/images/sinhsan/ovulation-2.svg}"
                  alt="Ng√†y c√≥ kh·∫£ nƒÉng th·ª• thai (ng√†y th·ª© hai)"
                />
                <b>Ng√†y c√≥ kh·∫£ nƒÉng th·ª• thai (ng√†y th·ª© hai)</b
                ><span style="margin-left: 6px"
                  >Ng√†y th·ª© hai trong c·ª≠a s·ªï th·ª• thai.</span
                >
              </li>
              <li>
                <img
                  class="cycle-legend-icon"
                  th:src="@{/images/sinhsan/ovulation-2.svg}"
                  alt="Ng√†y c√≥ kh·∫£ nƒÉng th·ª• thai"
                />
                <b>Ng√†y c√≥ kh·∫£ nƒÉng th·ª• thai</b
                ><span style="margin-left: 6px"
                  >C√°c ng√†y trong c·ª≠a s·ªï th·ª• thai (kh√¥ng ph·∫£i ng√†y th·ª© hai,
                  kh√¥ng ph·∫£i hai ng√†y tr∆∞·ªõc r·ª•ng tr·ª©ng).</span
                >
              </li>
              <li>
                <img
                  class="cycle-legend-icon"
                  th:src="@{/images/sinhsan/ovulation-3.svg}"
                  alt="Ng√†y c√≥ kh·∫£ nƒÉng th·ª• thai (hai ng√†y tr∆∞·ªõc r·ª•ng tr·ª©ng)"
                />
                <b>Ng√†y c√≥ kh·∫£ nƒÉng th·ª• thai (hai ng√†y tr∆∞·ªõc r·ª•ng tr·ª©ng)</b
                ><span style="margin-left: 6px"
                  >Hai ng√†y tr∆∞·ªõc r·ª•ng tr·ª©ng, kh·∫£ nƒÉng th·ª• thai tƒÉng.</span
                >
              </li>
              <li>
                <img
                  class="cycle-legend-icon"
                  th:src="@{/images/sinhsan/ovulation-4.svg}"
                  alt="Ng√†y c√≥ kh·∫£ nƒÉng th·ª• thai cao"
                />
                <b>Ng√†y c√≥ kh·∫£ nƒÉng th·ª• thai cao</b
                ><span style="margin-left: 6px"
                  >M·ªôt ng√†y tr∆∞·ªõc r·ª•ng tr·ª©ng, kh·∫£ nƒÉng th·ª• thai cao.</span
                >
              </li>
              <li>
                <img
                  class="cycle-legend-icon"
                  th:src="@{/images/sinhsan/ovulation-5.svg}"
                  alt="Ng√†y tr·ª©ng r·ª•ng, c√≥ kh·∫£ nƒÉng th·ª• thai cao nh·∫•t"
                />
                <b>Ng√†y tr·ª©ng r·ª•ng, c√≥ kh·∫£ nƒÉng th·ª• thai cao nh·∫•t</b
                ><span style="margin-left: 6px"
                  >Ng√†y r·ª•ng tr·ª©ng, kh·∫£ nƒÉng th·ª• thai cao nh·∫•t.</span
                >
              </li>
              <li>
                <img
                  class="cycle-legend-icon"
                  th:src="@{/images/sinhsan/ovulation-6.svg}"
                  alt="T·ª∑ l·ªá th·ª• thai gi·∫£m"
                />
                <b>T·ª∑ l·ªá th·ª• thai gi·∫£m</b
                ><span style="margin-left: 6px"
                  >M·ªôt ng√†y sau r·ª•ng tr·ª©ng, kh·∫£ nƒÉng th·ª• thai gi·∫£m.</span
                >
              </li>
              <li>
                <img
                  class="cycle-legend-icon"
                  th:src="@{/images/sinhsan/relatively-safe.svg}"
                  alt="Ng√†y an to√†n t∆∞∆°ng ƒë·ªëi"
                />
                <b>Ng√†y an to√†n t∆∞∆°ng ƒë·ªëi</b
                ><span style="margin-left: 6px"
                  >Sau h√†nh kinh, tr∆∞·ªõc c·ª≠a s·ªï th·ª• thai.</span
                >
              </li>
              <li>
                <img
                  class="cycle-legend-icon"
                  th:src="@{/images/sinhsan/absolutely-safe.svg}"
                  alt="Ng√†y an to√†n tuy·ªát ƒë·ªëi"
                />
                <b>Ng√†y an to√†n tuy·ªát ƒë·ªëi</b
                ><span style="margin-left: 6px"
                  >Cu·ªëi chu k·ª≥, sau c·ª≠a s·ªï th·ª• thai.</span
                >
              </li>
              <li>
                <img
                  class="cycle-legend-icon"
                  th:src="@{/images/sinhsan/test-pregnancy.svg}"
                  alt="Th·ª≠ thai"
                />
                <b>Th·ª≠ thai</b
                ><span style="margin-left: 6px"
                  >M·ªôt tu·∫ßn sau r·ª•ng tr·ª©ng, n√™n th·ª≠ thai.</span
                >
              </li>
            </ul>
          </div>
          <h2 class="cycle-section-title">Nh·∫Øc nh·ªü</h2>
          <ul class="cycle-info-list">
            <li>
              <span class="cycle-highlight">Ng√†y r·ª•ng tr·ª©ng d·ª± ki·∫øn:</span>
              <span
                th:text="${#temporals.format(ovulation, 'dd-MM-yyyy')}"
              ></span>
            </li>
            <li>
              <span class="cycle-highlight">C·ª≠a s·ªï th·ª• thai:</span>
              <span
                th:text="${#temporals.format(fertileWindow[0], 'dd-MM-yyyy')}"
              ></span>
              ƒë·∫øn
              <span
                th:text="${#temporals.format(fertileWindow[1], 'dd-MM-yyyy')}"
              ></span>
            </li>
          </ul>
          <form
            th:action="@{/cycles/add-reminder}"
            method="post"
            class="cycle-reminder-form"
          >
            <input type="hidden" name="cycleId" th:value="${cycle.id}" />
            <div class="cycle-reminder-group">
              <label class="cycle-reminder-label">Lo·∫°i thu·ªëc tr√°nh thai:</label>
              <select name="method" class="cycle-reminder-select" required>
                <option value="PILL_21">Thu·ªëc 21 vi√™n</option>
                <option value="PILL_28">Thu·ªëc 28 vi√™n</option>
              </select>
            </div>
            <div class="cycle-reminder-group">
              <label class="cycle-reminder-radio">
                <input
                  type="radio"
                  name="pillOption"
                  value="auto"
                  checked
                  onclick="document.getElementById('pillTimeInput').style.display='none';"
                />
                ƒê·ªÉ h·ªá th·ªëng t·ª± t·∫°o l·ªãch nh·∫Øc (gi·ªù m·∫∑c ƒë·ªãnh 20:00)
              </label>
            </div>
            <div class="cycle-reminder-group">
              <label class="cycle-reminder-radio">
                <input
                  type="radio"
                  name="pillOption"
                  value="manual"
                  onclick="document.getElementById('pillTimeInput').style.display='block';"
                />
                T√¥i mu·ªën ch·ªçn gi·ªù nh·∫Øc u·ªëng thu·ªëc
              </label>
              <div
                id="pillTimeInput"
                class="cycle-reminder-time"
                style="display: none; margin-top: 8px"
              >
                <input
                  type="time"
                  name="pillTime"
                  class="cycle-reminder-time-input"
                />
              </div>
            </div>
            <button type="submit" class="cycle-reminder-btn">
              T·∫°o l·ªãch nh·∫Øc
            </button>
          </form>

          <!-- Th√™m danh s√°ch l·ªãch nh·∫Øc v√† n√∫t x√≥a nhi·ªÅu -->
          <h3 class="cycle-pill-title">L·ªãch u·ªëng thu·ªëc tr√°nh thai:</h3>
          <ul class="cycle-pill-list">
            <li th:each="reminder : ${pillReminders}">
              <label>
                <input
                  type="checkbox"
                  class="reminder-checkbox"
                  data-reminder-id="[[${reminder.id}]]"
                  th:value="${reminder.id}"
                  onclick="syncCheckboxes(this)"
                />
                <span class="cycle-pill-icon">üíä</span>
                <span
                  th:text="${#temporals.format(reminder.date, 'dd-MM-yyyy')}"
                ></span>
                <span th:if="${reminder.time != null}">
                  - Nh·∫Øc l√∫c <span th:text="${reminder.time}"></span>
                </span>
              </label>
            </li>
          </ul>
          <form
            id="reminderNotifyForm"
            style="margin-bottom: 10px; display: inline"
          >
            <input
              type="hidden"
              name="notifyReminderIds"
              id="notifyReminderIds"
            />
            <button
              type="button"
              class="cycle-reminder-btn"
              onclick="notifySelectedReminders()"
              style="margin-right: 10px"
            >
              Nh·∫Øc nh·ªü c√°c l·ªãch ƒë√£ ch·ªçn
            </button>
          </form>
          <form
            th:action="@{/cycles/delete-reminders}"
            method="post"
            id="multiDeleteForm"
            style="display: inline"
          >
            <input type="hidden" name="cycleId" th:value="${cycle.id}" />
            <!-- S·ª≠ d·ª•ng nhi·ªÅu input hidden cho t·ª´ng id -->
            <span id="deleteReminderInputs"></span>
            <button
              type="submit"
              class="cycle-reminder-delete-btn"
              onclick="return confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a c√°c l·ªãch nh·∫Øc ƒë√£ ch·ªçn?')"
            >
              X√≥a c√°c l·ªãch nh·∫Øc ƒë√£ ch·ªçn
            </button>
          </form>
          <script>
            // ƒê·ªìng b·ªô checkbox v√† c·∫≠p nh·∫≠t hidden input cho c·∫£ hai form
            function syncCheckboxes(changedCb) {
              const checkboxes =
                document.querySelectorAll(".reminder-checkbox");
              const checkedIds = Array.from(checkboxes)
                .filter((cb) => cb.checked)
                .map((cb) => cb.value);
              document.getElementById("notifyReminderIds").value =
                checkedIds.join(",");
              // X√≥a c√°c input c≈©
              const deleteInputs = document.getElementById(
                "deleteReminderInputs"
              );
              deleteInputs.innerHTML = "";
              // Th√™m input hidden cho t·ª´ng id
              checkedIds.forEach((id) => {
                const input = document.createElement("input");
                input.type = "hidden";
                input.name = "reminderIds";
                input.value = id;
                deleteInputs.appendChild(input);
              });
            }
            function notifySelectedReminders() {
              const checked = document.querySelectorAll(
                ".reminder-checkbox:checked"
              );
              if (checked.length === 0) {
                alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt l·ªãch nh·∫Øc ƒë·ªÉ nh·∫≠n th√¥ng b√°o!");
                return;
              }
              let msg = "B·∫°n ƒë√£ ch·ªçn c√°c l·ªãch nh·∫Øc:\n";
              checked.forEach((cb) => {
                const label = cb.parentElement;
                msg += "- " + label.innerText.trim() + "\n";
              });
              alert(
                msg +
                  "\n(H·ªá th·ªëng s·∫Ω nh·∫Øc nh·ªü b·∫°n v√†o ƒë√∫ng th·ªùi gian ƒë√£ ch·ªçn n·∫øu b·∫°n b·∫≠t th√¥ng b√°o tr√™n tr√¨nh duy·ªát ho·∫∑c ·ª©ng d·ª•ng!)"
              );
            }
          </script>
          <a class="cycle-back-link" th:href="@{/cycles}">Quay l·∫°i</a>
        </div>
      </div>
    </div>
  </body>
</html>
