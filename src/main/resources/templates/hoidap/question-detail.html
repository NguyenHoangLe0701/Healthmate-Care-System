<!DOCTYPE html>
<html
  lang="vi"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout}"
>
  <head>
    <meta charset="UTF-8" />
    <title>Chi ti·∫øt c√¢u h·ªèi</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" th:href="@{/css/congdongchitiet.css}" />
    <script>
      function showImagePreview(event) {
        const input = event.target;
        const preview = document.getElementById("imagePreview");
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            preview.src = e.target.result;
            preview.style.display = "block";
          };
          reader.readAsDataURL(input.files[0]);
        } else {
          preview.src = "";
          preview.style.display = "none";
        }
      }
    </script>
  </head>
  <body>
    <div layout:fragment="content">
      <div class="main-wrap">
        <div class="questions-list">
          <div class="question-card">
            <div class="question-title" th:text="${question.title}"></div>
            <div class="question-content" th:text="${question.content}"></div>
            <div
              th:if="${question.imageUrl != null and question.imageUrl != ''}"
              style="margin: 12px 0"
            >
              <img
                th:src="${question.imageUrl}"
                alt="·∫¢nh minh h·ªça"
                style="
                  max-width: 400px;
                  max-height: 300px;
                  border: 1px solid #ccc;
                "
              />
            </div>
            <div class="question-meta">
              <span
                class="question-specialist"
                th:text="'Chuy√™n khoa ' + ${question.specialization}"
              ></span>
              <span>Tu·ªïi: <span th:text="${question.age}"></span></span>
              <span>Gi·ªõi t√≠nh: <span th:text="${question.gender}"></span></span>
            </div>
            <div class="question-meta">
              <span
                >Th·ªùi gian ƒëƒÉng:
                <span
                  th:text="${#temporals.format(question.createdAt, 'dd/MM/yyyy HH:mm')}"
                ></span
              ></span>
              <span th:if="${question.answeredAt != null}"
                >| Th·ªùi gian tr·∫£ l·ªùi:
                <span
                  th:text="${#temporals.format(question.answeredAt, 'dd/MM/yyyy HH:mm')}"
                ></span
              ></span>
            </div>
            <div th:if="${question.rejected}">
              <p style="color: red; font-weight: bold">
                C√¢u h·ªèi ƒë√£ b·ªã b√°c sƒ© t·ª´ ch·ªëi.
              </p>
              <p
                th:if="${question.rejectedReason != null && question.rejectedReason != ''}"
              >
                <b>L√Ω do t·ª´ ch·ªëi:</b>
                <span th:text="${question.rejectedReason}"></span>
              </p>
            </div>
            <div style="margin-top: 18px">
              <span
                th:if="${question.rejected}"
                style="color: red; font-weight: bold"
                >[ƒê√£ b·ªã t·ª´ ch·ªëi]</span
              >
              <span
                th:if="${(question.rejected == null or question.rejected == false) and (question.closed == true)}"
                style="color: red; font-weight: bold"
                >[ƒê√£ ƒë√≥ng]</span
              >
              <span
                th:if="${(question.closed == null or question.closed == false) and (question.rejected == null or question.rejected == false)}"
                style="color: green; font-weight: bold"
                >[ƒêang m·ªü]</span
              >
              <!-- N√∫t ƒë√≥ng/m·ªü v√† t·ª´ ch·ªëi c√¢u h·ªèi cho b√°c sƒ© -->
              <div style="margin: 12px 0">
                <form
                  th:if="${session.role == 'DOCTOR' and (question.closed == null or question.closed == false) and (question.rejected == null or question.rejected == false)}"
                  th:action="@{/cong-dong/toggle-close}"
                  method="post"
                  style="display: inline"
                >
                  <input
                    type="hidden"
                    name="questionId"
                    th:value="${question.id}"
                  />
                  <button
                    type="submit"
                    th:text="${question.closed} ? 'M·ªü l·∫°i c√¢u h·ªèi' : 'ƒê√≥ng c√¢u h·ªèi'"
                    class="close-question-btn"
                  ></button>
                </form>
                <span
                  th:if="${session.role == 'DOCTOR' and (question.closed == null or question.closed == false) and (question.rejected == null or question.rejected == false)}"
                >
                  <button
                    type="button"
                    onclick="document.getElementById('rejectForm').style.display='block'"
                    class="reject-question-btn"
                  >
                    T·ª´ ch·ªëi c√¢u h·ªèi
                  </button>
                  <form
                    id="rejectForm"
                    th:action="@{/cong-dong/reject}"
                    method="post"
                    style="display: none; margin-top: 8px"
                  >
                    <input
                      type="hidden"
                      name="questionId"
                      th:value="${question.id}"
                    />
                    <textarea
                      name="reason"
                      rows="2"
                      cols="40"
                      placeholder="Nh·∫≠p l√Ω do t·ª´ ch·ªëi..."
                    ></textarea
                    ><br />
                    <button type="submit" style="color: red">
                      X√°c nh·∫≠n t·ª´ ch·ªëi
                    </button>
                    <button
                      type="button"
                      onclick="document.getElementById('rejectForm').style.display='none'"
                    >
                      H·ªßy
                    </button>
                  </form>
                </span>
              </div>
            </div>
          </div>
          <div class="question-card">
            <h3 style="margin-bottom: 10px">Tr·∫£ l·ªùi</h3>
            <ul>
              <li th:each="a : ${answers}">
                <b th:text="${a.doctor.name}"></b>:
                <span th:text="${a.content}"></span>
                <span
                  style="color: #888; font-size: 0.9em"
                  th:text="${#temporals.format(a.createdAt, 'dd/MM/yyyy HH:mm')}"
                ></span>
                <!-- Hi·ªÉn th·ªã reply c·ªßa user cho t·ª´ng answer n·∫øu c√≥ -->
                <div
                  th:if="${a.userReply != null}"
                  style="
                    margin-top: 8px;
                    margin-left: 24px;
                    background: #f8fafc;
                    border-radius: 6px;
                    padding: 8px 12px;
                  "
                >
                  <b>B·∫°n:</b> <span th:text="${a.userReply}"></span>
                  <span
                    style="color: #888; font-size: 0.9em"
                    th:text="${a.userReplyAt != null ? #temporals.format(a.userReplyAt, 'dd/MM/yyyy HH:mm') : ''}"
                  ></span>
                </div>
                <!-- Form tr·∫£ l·ªùi l·∫°i b√°c sƒ©: ch·ªâ hi·ªán cho USER l√† ch·ªß c√¢u h·ªèi, n·∫øu c√¢u h·ªèi ch∆∞a ƒë√≥ng/ch∆∞a b·ªã t·ª´ ch·ªëi, ƒë√£ c√≥ tr·∫£ l·ªùi b√°c sƒ©, v√† user ch∆∞a reply -->
                <form
                  th:if="${session.role == 'USER' and (question.closed == null or question.closed == false) and (question.rejected == null or question.rejected == false) and a.userReply == null and question.user != null and session.userId != null and (question.user.id == session.userId or question.user.id.equals(session.userId))}"
                  th:action="@{/cong-dong/reply}"
                  method="post"
                  style="margin-top: 10px; margin-left: 24px"
                >
                  <input type="hidden" name="answerId" th:value="${a.id}" />
                  <textarea
                    name="replyContent"
                    rows="2"
                    cols="40"
                    placeholder="Ph·∫£n h·ªìi cho b√°c sƒ©..."
                    required
                    class="ask-form-input"
                  ></textarea>
                  <br />
                  <button
                    type="submit"
                    class="ask-form-btn"
                    style="width: auto; padding: 6px 18px; font-size: 1em"
                  >
                    G·ª≠i ph·∫£n h·ªìi
                  </button>
                </form>
              </li>
            </ul>
          </div>
          <!-- Form tr·∫£ l·ªùi cho b√°c sƒ© (n·∫øu l√† b√°c sƒ©) -->
          <div
            class="question-card"
            th:if="${session.role == 'DOCTOR' and (question.closed == null or question.closed == false) and (question.rejected == null or question.rejected == false)}"
          >
            <form th:action="@{/cong-dong/answer}" method="post">
              <input
                type="hidden"
                name="questionId"
                th:value="${question.id}"
              />
              <textarea
                name="content"
                placeholder="N·ªôi dung tr·∫£ l·ªùi"
                required
                class="ask-form-input"
              ></textarea>
              <br />
              <button type="submit" class="ask-form-btn">G·ª≠i tr·∫£ l·ªùi</button>
            </form>
          </div>
          <!-- N√∫t c·∫£m ∆°n hi·ªán ƒë·∫°i, ch·ªâ cho c·∫£m ∆°n 1 l·∫ßn, c·∫≠p nh·∫≠t giao di·ªán n·∫øu ƒë√£ c·∫£m ∆°n -->
          <div
            class="question-card"
            style="background: transparent; box-shadow: none; border: none"
          >
            <form
              id="thankForm"
              th:action="@{/cong-dong/thank}"
              method="post"
              style="
                display: flex;
                align-items: center;
                gap: 12px;
                border: none;
                background: none;
                box-shadow: none;
              "
              th:if="${session.role == 'USER'}"
            >
              <input
                type="hidden"
                name="questionId"
                th:value="${question.id}"
              />
              <button
                type="submit"
                id="thankBtn"
                class="thank-btn"
                th:classappend="${userThanked} ? ' disabled' : ''"
                th:disabled="${userThanked}"
                aria-label="C·∫£m ∆°n c√¢u h·ªèi n√†y"
              >
                <span
                  class="icon-heart"
                  th:text="${userThanked} ? '‚ù§Ô∏è' : 'ü§ç'"
                ></span>
                <span th:text="${userThanked} ? 'ƒê√£ c·∫£m ∆°n' : 'C·∫£m ∆°n'"></span>
              </button>
              <span class="thank-count">
                <i class="fa fa-heart" style="color: #10b981"></i>
                <span th:text="${question.thankCount}"></span>
              </span>
              <a th:href="@{/cong-dong}" class="back-link"
                >Quay l·∫°i danh s√°ch</a
              >
            </form>
          </div>
        </div>
        <!-- Form h·ªèi c√¢u h·ªèi cho USER -->
        <div class="ask-form-wrap" th:if="${session.role} == 'USER'">
          <div class="ask-form-box">
            <div class="ask-form-title">ƒê·∫∑t c√¢u h·ªèi cho b√°c sƒ©</div>
            <form
              th:action="@{/cong-dong/ask}"
              method="post"
              enctype="multipart/form-data"
              class="ask-form"
              id="askForm"
            >
              <div class="ask-form-row">
                <img
                  src="https://lh3.googleusercontent.com/a/ACg8ocIq4RXRTqIud49CLvJtqBbu76PPxJmposFsVLZAmV0_MUk6OcU=s96-c"
                  alt="avatar-user"
                  class="ask-form-avatar"
                />
                <input
                  name="age"
                  type="number"
                  placeholder="Tu·ªïi*"
                  required
                  class="ask-form-age ask-form-input"
                />
                <div class="ask-form-gender">
                  <label
                    ><input type="radio" name="gender" value="Nam" /> Nam</label
                  >
                  <label
                    ><input type="radio" name="gender" value="N·ªØ" checked />
                    N·ªØ</label
                  >
                </div>
              </div>
              <select name="specialization" class="ask-form-input" required>
                <option value="">Ch·ªçn chuy√™n khoa</option>
                <option value="Ph·ª• khoa">Chuy√™n khoa Ph·ª• khoa</option>
                <option value="Nam H·ªçc">Nam H·ªçc</option>
                <option value="S·∫£n">Chuy√™n khoa S·∫£n</option>
                <option value="N·ªôi nhi">Chuy√™n khoa N·ªôi nhi</option>
              </select>
              <input
                name="title"
                maxlength="150"
                placeholder="Ti√™u ƒë·ªÅ (vd: M·ªçc m·ª•n n∆∞·ªõc ·ªü l√≤ng b√†n tay)"
                required
                class="ask-form-input"
              />
              <textarea
                name="content"
                rows="4"
                placeholder="N·ªôi dung c√¢u h·ªèi (vd: M·ªói khi s·ª≠ d·ª•ng h√≥a ch·∫•t l√≤ng b√†n tay t√¥i b·ªã ƒë·ªè v√† m·ªçc m·ª•n n∆∞·ªõc. Nh·ªù b√°c sƒ© t∆∞ v·∫•n cho t√¥i n√™n s·ª≠ d·ª•ng thu·ªëc g√¨?) "
                required
                class="ask-form-input"
              ></textarea>
              <label class="ask-form-image">
                <img
                  src="https://cdn-icons-png.flaticon.com/512/1828/1828925.png"
                  alt="Th√™m ·∫£nh"
                />
                <span>Th√™m ·∫£nh</span>
                <input
                  type="file"
                  name="imageFile"
                  accept="image/*"
                  style="display: none"
                  onchange="showImagePreview(event)"
                />
              </label>
              <img
                id="imagePreview"
                class="ask-form-image-preview"
                style="display: none"
              />
              <div class="ask-form-note">
                * C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã c√¥ng khai
              </div>
              <button type="submit" class="ask-form-btn">G·ª¨I</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
